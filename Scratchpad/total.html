<html>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  <body onload="init()">
    <p>
      <svg
        width="1000"
        height="1000"
        id="svg_Bar"
        style="border: solid; display: block; margin: auto;"
        class="w3-cell-middle"
      ></svg>
    </p>

    <script>
      function barChart(data) {
        const margin = 60;
        const width = 1000 - 2 * margin;
        const height = 1000 - 2 * margin;

        const weeksInYear = data.map((d) => d.mmwrweek);

        const xScale = d3
          .scaleBand()
          .range([0, width])
          .domain(weeksInYear)
          .padding(0.2);

        const yScale = d3.scaleLinear().range([height, 0]).domain([0, 700]);
        const invert_yScale = d3
          .scaleLinear()
          .range([height, 0])
          .domain([700, 0]);

        const svg = d3.select("svg");

        const chart = svg
          .append("g")
          .attr("transform", `translate(${margin}, ${margin})`);

        chart.append("g").call(d3.axisLeft(yScale));

        chart
          .append("g")
          .attr("transform", `translate(0, ${height})`)
          .call(d3.axisBottom(xScale));

        // var bar = chart
        //   .selectAll()
        //   .data(data)
        //   .enter()
        //   .append("rect")
        //   .attr("class", "barchart")
        //   .attr("x", (d) => xScale(d.mmwrweek))
        //   .attr("y", (d) => yScale(d["covid_19_u071_multiple_cause_of_death"]))
        //   .attr("width", xScale.bandwidth())
        //   //.transition()
        //   //.duration(500)
        //   //.attr("height", (d) => height - yScale(d[btn.title]))
        //   .attr("fill", "#69b3a2");

        var colorScale = d3
          .scaleOrdinal()
          .domain([
            "covid_19_u071_multiple_cause_of_death",
            "covid_19_u071_underlying_cause_of_death",
          ])
          .range(["orange", "blue"]);

        var stackLayout = d3
          .stack()
          .keys([
            "covid_19_u071_multiple_cause_of_death",
            "covid_19_u071_underlying_cause_of_death",
          ]);

        var bar = chart
          .selectAll()
          .data(stackLayout(data))
          .enter()
          .append("g")
          .attr("class", "barchart")
          .each(function (d) {
            d3.select(this)
              .selectAll("rect")
              .data(d)
              .enter()
              .append("rect")
              .attr("x", (p, i) => xScale(i))
              //   .attr("log", function (d) {
              //     console.log(d);
              //   })
              .attr("y", (p) => yScale(p[1]))

              .attr("width", xScale.bandwidth())
              .attr("height", (p) => invert_yScale(p[1]) - invert_yScale(p[0]))
              .attr("fill", colorScale(d.key));
          });

        // bar
        //   .transition()
        //   .duration(500)
        //   .attr(
        //     "height",
        //     (d) => height - yScale(d["covid_19_u071_multiple_cause_of_death"])
        //   );

        // bar.on("mouseenter", function (d, i) {
        //   d3.select(this).attr("fill", "orange");

        //   chart
        //     .append("line")
        //     .attr("class", "valueLine")
        //     .attr("x1", 0)
        //     .attr("y1", yScale(d["covid_19_u071_underlying_cause_of_death"]))
        //     .attr("x2", width)
        //     .attr("y2", yScale(d["covid_19_u071_underlying_cause_of_death"]))
        //     .attr("stroke", "orange");
        // });

        // bar.on("mouseleave", function (d, i) {
        //   d3.select(this).attr("fill", "#69b3a2");
        //   chart.selectAll(".valueLine").remove();
        // });

        bar
          .on("mouseover", function () {
            tooltip.style("display", null);
          })
          .on("mouseout", function () {
            tooltip.style("display", "none");
          })
          .on("mousemove", function (d, i) {
            var xPosition = d3.mouse(this)[0] + 20;
            var yPosition = d3.mouse(this)[1] + 20;
            console.log(weeksInYear);

            if (this.children[0].attributes.fill.nodeValue == "orange") {
              tooltip.attr(
                "transform",
                "translate(" + xPosition + "," + yPosition + ")"
              );
              tooltip.select("text").text(d[0]);
            } else {
              tooltip.attr(
                "transform",
                "translate(" + xPosition + "," + yPosition + ")"
              );
              tooltip.select("text").text(d[1]);
            }
          });

        // Prep the tooltip bits, initial display is hidden
        var tooltip = svg
          .append("g")
          .attr("class", "tooltip")
          .style("display", "none");

        tooltip
          .append("rect")
          .attr("width", 30)
          .attr("height", 20)
          .attr("fill", "white")
          .style("opacity", 0.5);

        tooltip
          .append("text")
          .attr("x", 15)
          .attr("dy", "1.2em")
          .style("text-anchor", "middle")
          .attr("font-size", "12px")
          .attr("font-weight", "bold");

        svg
          .append("text")
          .attr("x", -(height / 2) - margin)
          .attr("y", margin / 2.4)
          .attr("transform", "rotate(-90)")
          .attr("text-anchor", "middle")
          .text("Number of Deaths");

        svg
          .append("text")
          .attr("class", "title")
          .attr("x", width / 2 + margin)
          .attr("y", 40)
          .attr("text-anchor", "middle")
          .text("")
          .text("Arizona Deaths from Covid-19");

        svg
          .append("text")
          .attr("x", width / 2 + margin)
          .attr("y", 580)
          .attr("text-anchor", "middle")
          .text("Week of the Year");
      }

      function clearChart() {
        d3.selectAll(".title").remove();
        d3.selectAll(".barchart").remove();
      }

      async function init() {
        let data = await d3.csv(
          "https://jtayl7.github.io/Weekly_Deaths_AZ_2020.csv"
        );

        barChart(data);
      }
    </script>
  </body>
</html>
